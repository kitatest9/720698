name: VPS_Final_Fixed_24.04
on:
  push:
  workflow_dispatch:

jobs:
  run-vps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Tools (Manual Binaries)
        run: |
          sudo apt-get update && sudo apt-get install tmate curl wget tar -y
          
          # 1. Cloudflared Direct Download
          wget -q https://github.com -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

          # 2. FileBrowser Direct Download
          wget -q https://github.com
          tar -xzf linux-amd64-filebrowser.tar.gz
          chmod +x filebrowser
          sudo mv filebrowser /usr/local/bin/

          # 3. savecode Command
          echo -e "#!/bin/bash\ngit config --global user.name 'VPS-Bot'\ngit config --global user.email 'bot@github.com'\ngit add .\ngit commit -m 'Save: \$(date)'\ngit push origin main" | sudo tee /usr/local/bin/savecode
          sudo chmod +x /usr/local/bin/savecode

      - name: Start & Send Links
        run: |
          # Start Services
          nohup filebrowser --noauth --address 0.0.0.0 --port 8080 --root . > /dev/null 2>&1 &
          nohup cloudflared tunnel --url http://localhost:8080 > cf.log 2>&1 &
          tmate -S /tmp/tmate.sock new-session -d
          
          sleep 45
          
          SSH_LINK=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          CF_URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' cf.log | head -n 1)
          
          # Discord Send
          curl -X POST -H "Content-Type: application/json" -d "{
            \"content\": \"ğŸš€ **VPS Started!**\nğŸ’» **SSH:** \`$SSH_LINK\`\nğŸ“ **File Manager:** $CF_URL\nğŸ“ **Save:** Type \`savecode\`\"
          }" ${{ secrets.DISCORD_WEBHOOK }}

      - name: Auto-Save Loop
        run: |
          sleep 20400
          savecode || echo "Nothing to save"
          curl -X POST -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com{{ github.repository }}/actions/workflows/vps.yml/dispatches \
          -d '{"ref":"main"}'
