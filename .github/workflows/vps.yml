name: Pro_VPS_Fixed_Loop
on:
  push:
  workflow_dispatch:

jobs:
  run-vps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Tools & Cloudflare
        run: |
          sudo apt update && sudo apt install tmate curl wget tar -y
          
          # 1. Cloudflared (Tunnel) Install
          wget -q https://github.com
          sudo dpkg -i cloudflared-linux-amd64.deb
          
          # 2. FileBrowser Manual Install (Fixed Download from GitHub)
          wget -q https://github.com
          tar -xzf linux-amd64-filebrowser.tar.gz
          sudo mv filebrowser /usr/local/bin/
          sudo chmod +x /usr/local/bin/filebrowser

          # 3. Setup 'savecode' Command
          echo '#!/bin/bash
          git config --global user.name "VPS-User"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Manual Save: $(date)"
          git push origin main
          echo "‚úÖ Files GitHub par save ho gayi hain!"' | sudo tee /usr/local/bin/savecode
          sudo chmod +x /usr/local/bin/savecode

      - name: Start Services & Send Links
        run: |
          # File Manager Start (No Auth)
          nohup filebrowser --noauth --address 0.0.0.0 --port 8080 --root . > /dev/null 2>&1 &
          
          # Cloudflare Tunnel Start (Wait for link)
          nohup cloudflared tunnel --url http://localhost:8080 > cf.log 2>&1 &
          
          # Tmate Start
          tmate -S /tmp/tmate.sock new-session -d
          
          # 40 seconds wait taake Cloudflare link generate ho jaye
          sleep 40
          
          # Links Collect
          SSH_LINK=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          CF_URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' cf.log | head -n 1)
          
          # Discord Alert
          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üî• Pro VPS Started (Fixed)\",
              \"color\": 15158332,
              \"fields\": [
                {\"name\": \"üíª Terminal (SSH)\", \"value\": \"\`$SSH_LINK\`\", \"inline\": false},
                {\"name\": \"üìÅ File Manager (Cloudflare)\", \"value\": \"$CF_URL\", \"inline\": false},
                {\"name\": \"üìù Save Code\", \"value\": \"Type \`savecode\` in terminal\", \"inline\": false}
              ]
            }]
          }" ${{ secrets.DISCORD_WEBHOOK }}

      - name: 5.5-Hour Loop & Auto-Save
        run: |
          sleep 20000
          # Auto-Save before restart
          savecode || echo "Nothing to save"
          
          # Trigger Next Cycle
          curl -X POST -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com{{ github.repository }}/actions/workflows/vps.yml/dispatches \
          -d '{"ref":"main"}'
