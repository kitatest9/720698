name: Marin_VPS_Fixed
on:
  workflow_dispatch:
  push:

permissions:
  actions: write
  contents: write

jobs:
  ultimate-vps:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“‚ Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }} 
        fetch-depth: 0

    - name: ğŸŸ¢ Install Pro Tools (Fixed Download)
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq tmate curl wget tar
        
        # Cloudflared Direct Download Fix
        curl -L https://github.com -o cloudflared.deb
        sudo dpkg -i cloudflared.deb
        
        # FileBrowser Direct Download Fix
        wget -q https://github.com
        tar -xzf linux-amd64-filebrowser.tar.gz
        sudo mv filebrowser /usr/local/bin/

    - name: ğŸ’¾ Setup 'savecode' Command
      run: |
        git config --global user.email "marin-bot@auto.sync"
        git config --global user.name "Marin Auto-Saver"
        if [ -d ".github" ]; then mv .github /tmp/.github_hidden; fi
        
        echo '#!/bin/bash
        if [ -d "/tmp/.github_hidden" ]; then mv /tmp/.github_hidden ./.github; fi
        git add .
        git commit -m "ğŸ’¾ Save: $(date) [skip ci]" || echo "No changes"
        git push origin HEAD || echo "Push failed!"
        if [ -d ".github" ]; then mv .github /tmp/.github_hidden; fi' | sudo tee /usr/local/bin/savecode
        sudo chmod +x /usr/local/bin/savecode

    - name: ğŸŒ Start Web Panels & Tunnels
      run: |
        nohup filebrowser -a 0.0.0.0 -p 8080 -r . --noauth > /dev/null 2>&1 &
        nohup cloudflared tunnel --url http://127.0.0.1:8080 > /tmp/cf_file.log 2>&1 &
        sleep 40 
        FILE_URL=$(grep -o 'https://[-a-zA-Z0-9]*\.trycloudflare\.com' /tmp/cf_file.log | head -n 1)
        echo "FILE_MANAGER_URL=$FILE_URL" >> $GITHUB_ENV

    - name: ğŸ”„ Start Tmate & Discord Alert
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        tmate -S /tmp/tmate.sock new-session -d
        tmate -S /tmp/tmate.sock wait tmate-ready
        sleep 10
        SSH_LINK=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
        
        curl -H "Content-Type: application/json" -d "{
          \"content\": \"ğŸš€ **VPS Fixed!**\n\nğŸ“ **File Manager:** $FILE_MANAGER_URL\nğŸ’» **SSH:** \`$SSH_LINK\`\n\nğŸ“ **Save:** Type \`savecode\`\"
        }" $DISCORD_WEBHOOK
        
        sleep 20000
        savecode || true
        curl -X POST -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com{{ github.repository }}/actions/workflows/vps.yml/dispatches \
        -d '{"ref":"main"}'
        
